<!DOCTYPE html>
<html>
<head>
    <title>PrivateChat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <style>
        body { font-family: Arial; margin:0; }

        #login { padding:20px; }

        #app { display:none; height:100vh; }

        .container {
            display:flex;
            height:100%;
        }

        .users {
            width:30%;
            border-right:1px solid #ccc;
            overflow-y:auto;
        }

        .user {
            padding:15px;
            cursor:pointer;
            border-bottom:1px solid #eee;
        }

        .user.online {
            background:#eaffea;
        }

        .chat {
            width:70%;
            display:flex;
            flex-direction:column;
        }

        #chatHeader {
            padding:10px;
            border-bottom:1px solid #ccc;
            font-weight:bold;
        }

        #messages {
            flex:1;
            padding:10px;
            overflow-y:auto;
        }

        .input-area {
            display:flex;
            border-top:1px solid #ccc;
        }

        input {
            flex:1;
            padding:10px;
            border:none;
        }

        button {
            width:80px;
        }

        .message {
            max-width:70%;
            padding:8px 12px;
            margin:5px;
            border-radius:10px;
            clear:both;
        }

        .me {
            background:#dcf8c6;
            float:right;
        }

        .other {
            background:#f1f0f0;
            float:left;
        }
    </style>
</head>
<body>

<div id="login">
    <h2>PrivateChat</h2>
    <input id="username" placeholder="Kullanıcı adı (halim / arkadas)">
    <button onclick="login()">Giriş</button>
</div>

<div id="app">
    <div class="container">
        <div class="users" id="userList"></div>

        <div class="chat">
            <div id="chatHeader">Kullanıcı seçin</div>
            <div id="messages"></div>

            <div class="input-area">
                <input id="message" placeholder="Mesaj yaz...">
                <button onclick="send()">Gönder</button>
            </div>
        </div>
    </div>
</div>

<script>
const socket = io();

let myUsername = "";
let currentChatUser = "";
let allMessages = [];

// LOGIN
function login(){
    const username = document.getElementById("username").value.trim();

    if(username === ""){
        alert("Kullanıcı adı gir!");
        return;
    }

    myUsername = username;
    socket.emit("login", username);
}

// Login başarılı
socket.on("login_success", ()=>{
    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="block";
});

// Kullanıcı listesi
socket.on("user_list", (list)=>{
    const userList = document.getElementById("userList");
    userList.innerHTML = "";

    list.forEach(user=>{
        if(user.username === myUsername) return;

        const div = document.createElement("div");
        div.className = "user" + (user.online ? " online" : "");
        div.textContent = user.username;

        div.onclick = ()=>{
            currentChatUser = user.username;

            document.getElementById("chatHeader").textContent = "Sohbet: " + user.username;

            const messagesDiv = document.getElementById("messages");
            messagesDiv.innerHTML = "";

            allMessages.forEach(m=>{
                if(
                    (m.sender === myUsername && m.receiver === currentChatUser) ||
                    (m.sender === currentChatUser && m.receiver === myUsername)
                ){
                    addMessage(m.sender, m.message);
                }
            });

            document.querySelectorAll(".user").forEach(u => u.style.background="");
            div.style.background = "#d0e7ff";
        };

        userList.appendChild(div);
    });
});

// Eski mesajlar
socket.on("old_messages", (rows)=>{
    allMessages = rows;
});

// Yeni mesaj
socket.on("private_message", (data)=>{
    allMessages.push({
        sender: data.from,
        receiver: data.from === myUsername ? currentChatUser : myUsername,
        message: data.message
    });

    if(data.from === currentChatUser || data.from === myUsername){
        addMessage(data.from, data.message);
    }
});

// Mesaj gönder
function send(){
    if(!currentChatUser){
        alert("Önce kullanıcı seç!");
        return;
    }

    const input = document.getElementById("message");
    const message = input.value.trim();

    if(message === "") return;

    socket.emit("private_message", {
        to: currentChatUser,
        message: message
    });

    input.value="";
}

// Mesaj balonu
function addMessage(sender, message){
    const div = document.createElement("div");
    div.className = "message";

    if(sender === myUsername){
        div.classList.add("me");
    } else {
        div.classList.add("other");
    }

    div.textContent = message;

    const messages = document.getElementById("messages");
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}
</script>

</body>
</html>
